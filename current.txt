def run_claim(rec: dict) -> str:
    """
    Evaluate a single insurance claim record using the agent executor.
    Handles both new-style 'output' and legacy 'messages' return formats.
    """
    # Build the conversation context
    messages = [
        SystemMessage(content=system_prompt),
        HumanMessage(content="Evaluate this insurance claim:\n" + json.dumps(rec, indent=2))
    ]

    # Invoke the agent
    result = agent_executor.invoke({"messages": messages})

    # Debug: inspect the raw result if needed
    # print("DEBUG result:", result)

    # Prefer the new 'output' field if present
    if "output" in result and result["output"]:
        return result["output"].strip()

    # Fallback: extract from messages list
    if "messages" in result and result["messages"]:
        return result["messages"][-1].content.strip()

    # If neither is available, return a safe default
    return "No decision produced by agent."



Here are the package versions:
Package                                  Version
---------------------------------------- -------------------------------
aiohappyeyeballs                         2.6.1
aiohttp                                  3.12.15
aiosignal                                1.4.0
aiosqlite                                0.21.0
annotated-types                          0.7.0
anyio                                    4.6.2
argon2-cffi                              21.3.0
argon2-cffi-bindings                     21.2.0
arrow                                    1.3.0
asgiref                                  3.9.1
asttokens                                2.0.5
astunparse                               1.6.3
async-lru                                2.0.4
attrs                                    24.3.0
azure-common                             1.1.28
azure-core                               1.34.0
azure-identity                           1.21.0
azure-mgmt-core                          1.5.0
azure-mgmt-web                           8.0.0
azure-storage-blob                       12.23.0
azure-storage-file-datalake              12.17.0
babel                                    2.16.0
backoff                                  2.2.1
banks                                    2.2.0
bcrypt                                   4.3.0
beautifulsoup4                           4.12.3
black                                    24.10.0
bleach                                   6.2.0
blinker                                  1.7.0
boto3                                    1.36.2
botocore                                 1.36.3
build                                    1.3.0
cachetools                               5.5.1
certifi                                  2025.1.31
cffi                                     1.17.1
chardet                                  4.0.0
charset-normalizer                       3.3.2
chroma-hnswlib                           0.7.6
chromadb                                 1.0.7
click                                    8.1.7
cloudpickle                              3.0.0
colorama                                 0.4.6
coloredlogs                              15.0.1
comm                                     0.2.1
contourpy                                1.3.1
cryptography                             43.0.3
cycler                                   0.11.0
Cython                                   3.0.12
databricks-connect                       17.2.2
databricks-sdk                           0.49.0
dataclasses-json                         0.6.7
datasets                                 4.0.0
dbus-python                              1.3.2
debugpy                                  1.8.11
decorator                                5.1.1
deepeval                                 2.4.9
defusedxml                               0.7.1
Deprecated                               1.2.18
dill                                     0.3.8
dirtyjson                                1.0.8
distlib                                  0.3.9
distro                                   1.9.0
distro-info                              1.7+build1
docstring-to-markdown                    0.11
docx2txt                                 0.9
dotenv                                   0.9.9
dpcpp-cpp-rt                             2025.1.1
durationpy                               0.10
execnet                                  2.1.1
executing                                0.8.3
facets-overview                          1.1.1
fastapi                                  0.115.9
fastjsonschema                           2.21.1
filelock                                 3.18.0
filetype                                 1.2.0
flatbuffers                              25.2.10
fonttools                                4.55.3
fqdn                                     1.5.1
frozenlist                               1.7.0
fsspec                                   2023.5.0
gensim                                   4.3.3
gitdb                                    4.0.11
GitPython                                3.1.43
google-api-core                          2.20.0
google-auth                              2.40.0
google-cloud-core                        2.4.3
google-cloud-storage                     3.1.0
google-crc32c                            1.7.1
google-resumable-media                   2.7.2
googleapis-common-protos                 1.65.0
greenlet                                 3.2.4
griffe                                   1.12.1
grpcio                                   1.74.0
grpcio-status                            1.67.0
h11                                      0.14.0
hf-xet                                   1.1.8
httpcore                                 1.0.2
httplib2                                 0.20.4
httptools                                0.6.4
httpx                                    0.28.1
huggingface-hub                          0.34.4
humanfriendly                            10.0
idna                                     3.7
impi-rt                                  2021.15.0
importlib-metadata                       6.6.0
importlib_resources                      6.5.2
iniconfig                                1.1.1
intel-cmplr-lib-rt                       2025.1.1
intel-cmplr-lib-ur                       2025.1.1
intel-cmplr-lic-rt                       2025.1.1
intel-opencl-rt                          2025.1.1
intel-openmp                             2025.1.1
intel-pti                                0.12.3
intel-sycl-rt                            2025.1.1
ipyflow-core                             0.0.209
ipykernel                                6.29.5
ipython                                  8.30.0
ipython-genutils                         0.2.0
ipywidgets                               7.8.1
isodate                                  0.6.1
isoduration                              20.11.0
jedi                                     0.19.2
Jinja2                                   3.1.5
jiter                                    0.10.0
jmespath                                 1.0.1
joblib                                   1.4.2
json5                                    0.9.25
jsonpatch                                1.33
jsonpointer                              3.0.0
jsonschema                               4.23.0
jsonschema-specifications                2023.7.1
jupyter_client                           8.6.3
jupyter_core                             5.7.2
jupyter-events                           0.10.0
jupyter-lsp                              2.2.0
jupyter_server                           2.14.1
jupyter_server_terminals                 0.4.4
jupyterlab                               4.3.4
jupyterlab-pygments                      0.1.2
jupyterlab_server                        2.27.3
jupyterlab-widgets                       1.0.0
kiwisolver                               1.4.8
kubernetes                               33.1.0
langchain                                0.3.24
langchain-community                      0.3.0
langchain-core                           0.3.63
langchain-openai                         0.3.14
langchain-text-splitters                 0.3.8
langgraph                                0.4.3
langgraph-checkpoint                     2.1.1
langgraph-prebuilt                       0.5.1
langgraph-sdk                            0.2.3
langsmith                                0.1.147
launchpadlib                             1.11.0
lazr.restfulclient                       0.14.6
lazr.uri                                 1.0.6
llama-cloud                              0.1.35
llama-cloud-services                     0.6.54
llama-index                              0.12.38
llama-index-agent-openai                 0.4.8
llama-index-cli                          0.4.1
llama-index-core                         0.12.52.post1
llama-index-embeddings-openai            0.3.1
llama-index-indices-managed-llama-cloud  0.8.0
llama-index-instrumentation              0.4.0
llama-index-llms-openai                  0.3.42
llama-index-multi-modal-llms-openai      0.4.3
llama-index-program-openai               0.3.1
llama-index-question-gen-openai          0.3.0
llama-index-readers-file                 0.4.11
llama-index-readers-llama-parse          0.4.0
llama-index-workflows                    1.3.0
llama-parse                              0.6.54
markdown-it-py                           2.2.0
MarkupSafe                               3.0.2
marshmallow                              3.26.1
matplotlib                               3.10.0
matplotlib-inline                        0.1.7
mccabe                                   0.7.0
mdurl                                    0.1.0
mistune                                  2.0.4
mkl                                      2025.1.0
mlflow-skinny                            2.22.0
mmh3                                     5.1.0
mpmath                                   1.3.0
msal                                     1.32.3
msal-extensions                          1.3.1
multidict                                6.6.4
multiprocess                             0.70.16
mypy-extensions                          1.0.0
nbclient                                 0.8.0
nbconvert                                7.16.4
nbformat                                 5.10.4
nest-asyncio                             1.6.0
networkx                                 3.5
nltk                                     3.9.1
nodeenv                                  1.9.1
notebook                                 7.3.2
notebook_shim                            0.2.3
numpy                                    1.26.4
oauthlib                                 3.2.2
ollama                                   0.5.3
oneccl                                   2021.15.2
oneccl-devel                             2021.15.2
onemkl-sycl-blas                         2025.1.0
onemkl-sycl-dft                          2025.1.0
onemkl-sycl-lapack                       2025.1.0
onemkl-sycl-rng                          2025.1.0
onemkl-sycl-sparse                       2025.1.0
onnxruntime                              1.22.1
openai                                   1.75.0
opentelemetry-api                        1.36.0
opentelemetry-exporter-otlp-proto-common 1.36.0
opentelemetry-exporter-otlp-proto-grpc   1.36.0
opentelemetry-instrumentation            0.57b0
opentelemetry-instrumentation-asgi       0.57b0
opentelemetry-instrumentation-fastapi    0.57b0
opentelemetry-proto                      1.36.0
opentelemetry-sdk                        1.36.0
opentelemetry-semantic-conventions       0.57b0
opentelemetry-util-http                  0.57b0
orjson                                   3.11.2
ormsgpack                                1.10.0
overrides                                7.4.0
packaging                                24.1
pandas                                   2.2.3
pandocfilters                            1.5.0
parso                                    0.8.4
pathspec                                 0.10.3
patsy                                    1.0.1
pexpect                                  4.8.0
pillow                                   11.1.0
pip                                      25.0.1
platformdirs                             4.3.8
plotly                                   5.24.1
pluggy                                   1.5.0
portalocker                              3.2.0
posthog                                  6.6.1
prometheus_client                        0.21.0
prompt-toolkit                           3.0.43
propcache                                0.3.2
proto-plus                               1.26.1
protobuf                                 5.29.4
psutil                                   5.9.0
psycopg2                                 2.9.3
ptyprocess                               0.7.0
pure-eval                                0.2.2
py4j                                     0.10.9.9
pyarrow                                  19.0.1
pyasn1                                   0.4.8
pyasn1-modules                           0.2.8
pyccolo                                  0.0.71
pycparser                                2.21
pydantic                                 2.11.7
pydantic_core                            2.33.2
pydantic-settings                        2.10.1
pyflakes                                 3.2.0
Pygments                                 2.15.1
PyGObject                                3.48.2
pyiceberg                                0.9.0
PyJWT                                    2.10.1
PyMuPDF                                  1.25.5
pyodbc                                   5.2.0
pyparsing                                3.2.0
pypdf                                    5.9.0
PyPika                                   0.48.9
pyproject_hooks                          1.2.0
pyright                                  1.1.394
pyspark                                  4.0.0+databricks.connect.17.2.2
pytest                                   8.3.5
pytest-repeat                            0.9.4
pytest-xdist                             3.8.0
python-apt                               2.7.7+ubuntu5
python-dateutil                          2.9.0.post0
python-dotenv                            1.1.1
python-json-logger                       3.2.1
python-lsp-jsonrpc                       1.1.2
python-lsp-server                        1.12.0
pytoolconfig                             1.2.6
pytorch-triton-xpu                       3.4.0
pytz                                     2024.1
PyYAML                                   6.0.2
pyzmq                                    26.2.0
rank-bm25                                0.2.2
referencing                              0.30.2
regex                                    2025.7.34
requests                                 2.32.3
requests-oauthlib                        2.0.0
requests-toolbelt                        1.0.0
rfc3339-validator                        0.1.4
rfc3986-validator                        0.1.1
rich                                     13.9.4
rope                                     1.12.0
rpds-py                                  0.22.3
rsa                                      4.9.1
s3transfer                               0.11.3
safetensors                              0.6.2
scikit-learn                             1.6.1
scipy                                    1.13.1
seaborn                                  0.13.2
Send2Trash                               1.8.2
sentence-transformers                    4.1.0
sentry-sdk                               2.35.0
setuptools                               80.9.0
shellingham                              1.5.4
six                                      1.16.0
smart_open                               7.3.0.post1
smmap                                    5.0.0
sniffio                                  1.3.0
sortedcontainers                         2.4.0
soupsieve                                2.5
SQLAlchemy                               2.0.43
sqlparse                                 0.5.3
ssh-import-id                            5.11
stack-data                               0.2.0
starlette                                0.45.3
statsmodels                              0.14.4
strictyaml                               1.7.3
striprtf                                 0.0.26
sympy                                    1.14.0
tabulate                                 0.9.0
tbb                                      2022.1.0
tcmlib                                   1.3.0
tenacity                                 8.5.0
terminado                                0.17.1
threadpoolctl                            3.5.0
tiktoken                                 0.11.0
tinycss2                                 1.4.0
tokenize_rt                              6.1.0
tokenizers                               0.21.4
tomli                                    2.0.1
torch                                    2.8.0+xpu
tornado                                  6.4.2
tqdm                                     4.67.1
traitlets                                5.14.3
transformers                             4.55.4
typer                                    0.16.1
types-python-dateutil                    2.9.0.20241206
typing                                   3.7.4.3
typing_extensions                        4.12.2
typing-inspect                           0.9.0
typing-inspection                        0.4.1
tzdata                                   2024.1
ujson                                    5.10.0
umf                                      0.10.0
unattended-upgrades                      0.1
uri-template                             1.3.0
urllib3                                  2.3.0
uvicorn                                  0.34.2
uvloop                                   0.21.0
virtualenv                               20.29.3
wadllib                                  1.3.6
watchfiles                               1.1.0
wcwidth                                  0.2.5
webcolors                                24.11.1
webencodings                             0.5.1
websocket-client                         1.8.0
websockets                               15.0.1
whatthepatch                             1.0.2
wheel                                    0.45.1
widgetsnbextension                       3.6.6
wrapt                                    1.17.0
xxhash                                   3.5.0
yapf                                     0.40.2
yarl                                     1.20.1
zipp                                     3.21.0
zstandard                                0.23.0


  Here is the code that works until I run the cell with agent_executor = create_react_agent(llm, tools), I get this error:
TypeError                                 Traceback (most recent call last)
File <command-5180344499326945>, line 25
      3 import json
      5 system_prompt = """You are a Healthcare Insurance Claim Approval Agent.
      6 You have exactly 3 tools. Always use them in this exact order:
      7 
   (...)
     22 
     23 No markdown, no extra text, no bullets."""
---> 25 agent_executor = create_react_agent(llm, tools)
     27 def run_claim(rec):
     28     messages = [
     29         SystemMessage(content=system_prompt),
     30         HumanMessage(content="Evaluate this insurance claim:\n" + json.dumps(rec, indent=2))
     31     ]

File /local_disk0/.ephemeral_nfs/envs/pythonEnv-a4b12554-9008-4b5a-86ef-a68f1a4a133c/lib/python3.12/site-packages/langgraph/prebuilt/chat_agent_executor.py:663, in create_react_agent(model, tools, prompt, response_format, pre_model_hook, post_model_hook, state_schema, config_schema, checkpointer, store, interrupt_before, interrupt_after, debug, version, name)
I tried to change the versions but it keep failing:
%pip install langchain==0.1.16 langgraph==0.0.34 langchain-openai --upgrade
  PipError: Command 'pip --disable-pip-version-check install -c /databricks/.core_packages/immutable-package-constraints.txt langchain==0.1.16 langgraph==0.0.34 langchain-openai --upgrade' returned non-zero exit status 1.
[Trace ID: 00-8970a9f3db7844cdfc9df58d7f6409de-b717ba84ea12804e-00]
File <command-6815836300068737>, line 1
----> 1 get_ipython().run_line_magic('pip', 'install langchain==0.1.16 langgraph==0.0.34 langchain-openai --upgrade')

  Here is the rest of the code so far, is there a way to get this working with the current versions of the libs?

import json
import pandas as pd
from datetime import datetime
from typing import Dict, Any
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.messages import HumanMessage, SystemMessage
from langchain_core.output_parsers import StrOutputParser
from langgraph.graph import StateGraph, MessagesState
from langgraph.prebuilt import ToolNode, tools_condition, create_react_agent
from langchain_core.tools import tool
from dateutil import parser
import os
os.environ["OPENAI_API_KEY"] = "sk-" + "ant" + "api" + "key"

import os

# Starting directory (current working directory)
start_dir = '.'

# File name to search
target_file = 'reference_codes.json'

# Walk through directories and find matches
matches = []
for root, dirs, files in os.walk(start_dir):
    if target_file in files:
        matches.append(os.path.join(root, target_file))

if matches:
    print("Found the file at:")
    for match in matches:
        print(match)
else:
    print(f"'{target_file}' not found under {os.path.abspath(start_dir)}")

  
os.environ["OPENAI_API_KEY"] = "9b5ad71b2ce5302211f9c61530b329a4922fc6a4"

llm = ChatOpenAI(
    model="gpt-4o-mini",
    temperature=0
)

with open("./Data/reference_codes.json") as f:
    reference_codes = json.load(f)

with open("./Data/insurance_policies.json") as f:
    policies_raw = json.load(f)
    policy_dict = {p["policy_id"]: p for p in policies_raw}

with open("./Data/validation_records.json") as f:
    validation_records = json.load(f)

with open("./Data/test_records.json") as f:
    test_records = json.load(f)


# Add age to every record
def calc_age(dob, dos):
    b = datetime.strptime(dob, "%Y-%m-%d")
    s = datetime.strptime(dos, "%Y-%m-%d")
    age = s.year - b.year
    if (s.month, s.day) < (b.month, b.day):
        age -= 1
    return age

for recs in [validation_records, test_records]:
    for r in recs:
        r['age'] = calc_age(r['date_of_birth'], r['date_of_service'])

ref_str = json.dumps(reference_codes, indent=2)

@tool
def summarize_patient_record(record_str: str) -> str:
    """Create structured patient summary"""
    prompt = f"""You are an expert insurance summarizer.
Use these code descriptions (never make up codes):
ICD-10: {json.dumps({k:v for k,v in reference_codes.items() if not k.isdigit()}, ensure_ascii=False)}
CPT: {json.dumps({k:v for k,v in reference_codes.items() if k.isdigit()}, ensure_ascii=False)}

Return ONLY this exact format:

• Patient Demographics: [Name], [Gender], age [Age]
• Insurance Policy ID: [PolicyID]
• Diagnoses and Descriptions: [CODE] - [Description] (one per line)
• Procedures and Descriptions: [CODE] - [Description]
• Preauthorization Status: [Yes/No/Required but not obtained]
• Billed Amount (in USD): [Amount]
• Date of Service: [Date]

Patient record:
{record_str}"""
    return llm.invoke(prompt).content

@tool
def summarize_policy_guideline(policy_id: str) -> str:
    """Create structured policy summary"""
    policy = policy_dict.get(policy_id)
    if not policy:
        return "Policy not found"
    
    prompt = f"""You are an expert policy summarizer.
Use the reference codes below to expand CPT and ICD-10 codes.

Return ONLY this format:

• Policy Details: {policy_id} - {policy.get('plan_name','')}
• Covered Procedures:
{{for each procedure}}
  - Procedure Code and Description: [CPT] - [full description]
    Covered Diagnoses and Descriptions: [ICD1] - [desc1], [ICD2] - [desc2], ...
    Gender Restriction: {policy['covered_procedures'][i].get('gender','Any')}
    Age Range: {policy['covered_procedures'][i]['age_range'][0]} to {policy['covered_procedures'][i]['age_range'][1]} (inclusive min, exclusive max)
    Preauthorization Requirement: {'Yes' if policy['covered_procedures'][i].get('requires_preauthorization') else 'No'}
    Notes on Coverage: {policy['covered_procedures'][i].get('notes','None')}

Reference codes: {json.dumps(reference_codes, ensure_ascii=False)}"""
    return llm.invoke(prompt).content

@tool
def check_claim_coverage(record_summary: str, policy_summary: str) -> str:
    """Final coverage decision with reasoning"""
    prompt = f"""You are a strict claims adjudicator.
Approve ONLY if ALL these are true:
- Procedure exactly matches a covered CPT
- At least one diagnosis matches the allowed list for that CPT
- Age >= min and < max (max exclusive)
- Gender matches (Any = ok)
- Preauth required → must be obtained

Patient summary:
{record_summary}

Policy summary:
{policy_summary}

Return exactly these three sections:
• Coverage Review: step-by-step pass/fail checks
• Summary of Findings: bullets of passed/failed
• Final Decision: APPROVE or ROUTE FOR REVIEW + one-sentence reason"""
    return llm.invoke(prompt).content

tools = [summarize_patient_record, summarize_policy_guideline, check_claim_coverage]

from langgraph.prebuilt import create_react_agent
from langchain_core.messages import SystemMessage, HumanMessage
import json

system_prompt = """You are a Healthcare Insurance Claim Approval Agent.
You have exactly 3 tools. Always use them in this exact order:

1. Call summarize_patient_record with the full patient JSON
2. Extract the Policy ID from its output and call summarize_policy_guideline
3. Call check_claim_coverage with both summaries
4. After the 3rd tool returns, output the final decision.

Final output must be exactly:

Decision: APPROVE
Reason: <short accurate reason with codes, age, gender, preauth>

OR

Decision: ROUTE FOR REVIEW
Reason: <short reason why not approved>

No markdown, no extra text, no bullets."""

agent_executor = create_react_agent(llm, tools)

def run_claim(rec):
    messages = [
        SystemMessage(content=system_prompt),
        HumanMessage(content="Evaluate this insurance claim:\n" + json.dumps(rec, indent=2))
    ]
    result = agent_executor.invoke({"messages": messages})
    return result["messages"][-1].content.strip()

print("Agent fixed and ready!")
  
