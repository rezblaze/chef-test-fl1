import json
import pandas as pd
from datetime import datetime
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage
from langchain_core.tools import tool
from langgraph.prebuilt import create_react_agent

# --- Setup ---
os.environ["OPENAI_API_KEY"] = "your_api_key_here"

llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

# Load data
with open("./Data/reference_codes.json") as f:
    reference_codes = json.load(f)

with open("./Data/insurance_policies.json") as f:
    policies_raw = json.load(f)
    policy_dict = {p["policy_id"]: p for p in policies_raw}

with open("./Data/validation_records.json") as f:
    validation_records = json.load(f)

with open("./Data/test_records.json") as f:
    test_records = json.load(f)

# --- Helper: calculate age ---
def calc_age(dob, dos):
    b = datetime.strptime(dob, "%Y-%m-%d")
    s = datetime.strptime(dos, "%Y-%m-%d")
    age = s.year - b.year
    if (s.month, s.day) < (b.month, b.day):
        age -= 1
    return age

for recs in [validation_records, test_records]:
    for r in recs:
        r['age'] = calc_age(r['date_of_birth'], r['date_of_service'])

# --- Tools ---
@tool
def summarize_patient_record(record_str: str) -> str:
    """Create structured patient summary"""
    prompt = f"""You are an expert insurance summarizer.
ICD-10: {json.dumps({k:v for k,v in reference_codes.items() if not k.isdigit()}, ensure_ascii=False)}
CPT: {json.dumps({k:v for k,v in reference_codes.items() if k.isdigit()}, ensure_ascii=False)}

Return ONLY this exact format:
• Patient Demographics: [Name], [Gender], age [Age]
• Insurance Policy ID: [PolicyID]
• Diagnoses and Descriptions: [CODE] - [Description]
• Procedures and Descriptions: [CODE] - [Description]
• Preauthorization Status: [Yes/No/Required but not obtained]
• Billed Amount (in USD): [Amount]
• Date of Service: [Date]

Patient record:
{record_str}"""
    return llm.invoke(prompt).content

@tool
def summarize_policy_guideline(policy_id: str) -> str:
    """Create structured policy summary"""
    policy = policy_dict.get(policy_id)
    if not policy:
        return "Policy not found"
    prompt = f"""You are an expert policy summarizer.
Return ONLY this format:
• Policy Details: {policy_id} - {policy.get('plan_name','')}
• Covered Procedures: ...
Reference codes: {json.dumps(reference_codes, ensure_ascii=False)}"""
    return llm.invoke(prompt).content

@tool
def check_claim_coverage(record_summary: str, policy_summary: str) -> str:
    """Final coverage decision with reasoning"""
    prompt = f"""You are a strict claims adjudicator.
Approve ONLY if ALL rules are met.

Patient summary:
{record_summary}

Policy summary:
{policy_summary}

Return exactly:
• Coverage Review
• Summary of Findings
• Final Decision: APPROVE or ROUTE FOR REVIEW"""
    return llm.invoke(prompt).content

tools = [summarize_patient_record, summarize_policy_guideline, check_claim_coverage]

system_prompt = """You are a Healthcare Insurance Claim Approval Agent.
You have exactly 3 tools. Always use them in this exact order:
1. summarize_patient_record
2. summarize_policy_guideline
3. check_claim_coverage
Final output must be:
Decision: APPROVE
Reason: <short reason>
OR
Decision: ROUTE FOR REVIEW
Reason: <short reason>
"""

# --- ✅ Create the agent executor ---
agent_executor = create_react_agent(model=llm, tools=tools)

# --- Claim runner ---
def run_claim(rec: dict) -> str:
    messages = [
        SystemMessage(content=system_prompt),
        HumanMessage(content="Evaluate this insurance claim:\n" + json.dumps(rec, indent=2))
    ]
    result = agent_executor.invoke({"messages": messages})

    if "output" in result and result["output"]:
        return result["output"].strip()
    if "messages" in result and result["messages"]:
        return result["messages"][-1].content.strip()
    return "No decision produced by agent."

# --- Batch run ---
results = []
print("Processing test records...")
for rec in test_records:
    print(f"→ {rec['patient_id']}")
    resp = run_claim(rec)
    results.append({"patient_id": rec["patient_id"], "generated_response": resp})

submission_df = pd.DataFrame(results)[["patient_id", "generated_response"]]
submission_df.to_csv("submission.csv", index=False)

print("\nDONE! submission.csv created")
submission_df.head()
