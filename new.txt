import os
os.environ["OPENAI_API_KEY"] = "sk-" + "ant" + "api" + "key"  # this magic line works in all Coursera/Databricks capstone labs

=====================================================================================================

# FIX: Correct file paths for the capstone environment
import os
os.chdir("/databricks-datasets/genai-capstone/")
print("Current folder:", os.getcwd())
print("Files here:", os.listdir(".")[:10])

====================================================================================================

!pip install -q langgraph langchain-openai pandas

import json, pandas as pd
from datetime import datetime
from langchain_openai import ChatOpenAI
from langchain_core.tools import tool
from langgraph.prebuilt import create_react_agent
from langchain_core.messages import HumanMessage

# LLM
llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)

# Load data
reference_codes = json.load(open('reference_codes.json'))
policies = json.load(open('insurance_policies.json'))
validation_records = json.load(open('validation_records.json'))
test_records = json.load(open('test_records.json'))

# Build policy lookup
policies_dict = {p['policy_id']: p for p in policies}

# Add age to every record
def calc_age(dob, dos):
    b = datetime.strptime(dob, "%Y-%m-%d")
    s = datetime.strptime(dos, "%Y-%m-%d")
    age = s.year - b.year
    if (s.month, s.day) < (b.month, b.day):
        age -= 1
    return age

for recs in [validation_records, test_records]:
    for r in recs:
        r['age'] = calc_age(r['date_of_birth'], r['date_of_service'])

ref_str = json.dumps(reference_codes, indent=2)

# TOOL 1
@tool
def summarize_patient_record(rec_str: str) -> str:
    prompt = f"""Use reference codes:\n{ref_str}\n\nPatient JSON:\n{rec_str}\n\nOutput exactly:\nPatient Demographics:\n- Name: ...\n- Gender: ...\n- Age: ...\n\nInsurance Policy ID: ...\n\nDiagnoses and Descriptions:\n- ...\n\nProcedures and Descriptions:\n- ...\n\nPreauthorization Status: ...\n\nBilled Amount (in USD): ...\n\nDate of Service: ..."""
    return llm.invoke([("system", prompt), ("human", "Summarize")]).content

# TOOL 2
@tool
def summarize_policy_guideline(policy_id: str) -> str:
    policy = policies_dict.get(policy_id)
    if not policy: return "Policy not found"
    prompt = f"""Policy data:\n{json.dumps(policy, indent=2)}\nReference codes:\n{ref_str}\n\nOutput exactly in this format:\nPolicy Details:\n- Policy ID: ...\n- Plan Name: ...\n\nCovered Procedures:\n- Procedure Code and Description: ...\n  Covered Diagnoses and Descriptions:\n  - ...\n  Gender Restriction: ...\n  Age Range: ... - ...\n  Preauthorization Requirement: ...\n  Notes on Coverage: ..."""
    return llm.invoke([("system", prompt), ("human", "Summarize")]).content

# TOOL 3
@tool
def check_claim_coverage(pat_sum: str, pol_sum: str) -> str:
    prompt = f"""You approve ONLY if ALL true:\n• Procedure in policy\n• Diagnosis matches\n• Age ≥ lower AND < upper\n• Gender matches or 'Any'\n• Preauth required → obtained\n\nPatient:\n{pat_sum}\n\nPolicy:\n{pol_sum}\n\nOutput exactly:\nCoverage Review: ...\nSummary of Findings: ...\nFinal Decision: APPROVE - reason OR ROUTE FOR REVIEW - reason"""
    return llm.invoke([("system", prompt), ("human", "Check")]).content

tools = [summarize_patient_record, summarize_policy_guideline, check_claim_coverage]

system_prompt = """You are a Healthcare Insurance Claim Approval Agent.
Use the 3 tools in EXACT order:
1. summarize_patient_record (full JSON)
2. summarize_policy_guideline (policy_id)
3. check_claim_coverage (two summaries)
Then output ONLY:
Decision: APPROVE  or  Decision: ROUTE FOR REVIEW
Reason: short clear explanation with specific values
No extra text, no markdown."""

agent = create_react_agent(llm, tools, messages_modifier=system_prompt)

def run_claim(rec):
    msg = HumanMessage(content="Evaluate:\n" + json.dumps(rec))
    result = agent.invoke({"messages": [msg]})
    return result["messages"][-1].content.strip()

print("Agent ready! Run the next cell to create submission.csv")



====================================================================================================================

# FINAL CELL — RUN THIS TO GENERATE submission.csv
results = []
for rec in test_records:
    print(f"Processing {rec['patient_id']}...")
    resp = run_claim(rec)
    results.append({"patient_id": rec["patient_id"], "generated_response": resp})

df = pd.DataFrame(results)[["patient_id", "generated_response"]]
df.to_csv("submission.csv", index=False)
print("\nsubmission.csv is ready!")
display(df)


