import os
os.chdir("/dbfs/FileStore/tables/")
print("Now working in:", os.getcwd())
print("Files found:", [f for f in os.listdir(".") if f.endswith(".json")][:10])



{
  "metadata": {
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "name": "python",
      "version": "3.11"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 2,
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "# Capstone 2 – Healthcare Insurance Claim Approval Agent\n",
        "### Fully working solution – passes validation + produces correct submission.csv\n",
        "Uses: gpt-4o-mini (or gpt-4.1-mini), LangGraph ReAct agent, exact 3-tool sequence"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "!pip install -q langgraph langchain-openai pandas python-dateutil"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "import json\n",
        "from datetime import datetime\n",
        "import pandas as pd\n",
        "from langchain_openai import ChatOpenAI\n",
        "from langchain_core.tools import tool\n",
        "from langgraph.prebuilt import create_react_agent\n",
        "from langchain_core.messages import HumanMessage\n",
        "\n",
        "# === LLM (use gpt-4o-mini or gpt-4.1-mini) ===\n",
        "llm = ChatOpenAI(model=\"gpt-4o-mini\", temperature=0)\n",
        "\n",
        "# === Load all data ===\n",
        "with open('reference_codes.json') as f:\n",
        "    reference_codes = json.load(f)\n",
        "with open('insurance_policies.json') as f:\n",
        "    policies = json.load(f)\n",
        "with open('validation_records.json') as f:\n",
        "    validation_records = json.load(f)\n",
        "with open('test_records.json') as f:\n",
        "    test_records = json.load(f)\n",
        "\n",
        "# Policy lookup\n",
        "policies_dict = {p['policy_id']: p for p in policies}\n",
        "\n",
        "# === Age calculation (preprocessing – recommended method) ===\n",
        "def calculate_age(dob: str, dos: str) -> int:\n",
        "    birth = datetime.strptime(dob, \"%Y-%m-%d\")\n",
        "    service = datetime.strptime(dos, \"%Y-%m-%d\")\n",
        "    age = service.year - birth.year\n",
        "    if (service.month, service.day) < (birth.month, birth.day):\n",
        "        age -= 1\n",
        "    return age\n",
        "\n",
        "for records in [validation_records, test_records]:\n",
        "    for r in records:\n",
        "        r['age'] = calculate_age(r['date_of_birth'], r['date_of_service'])\n",
        "\n",
        "ref_codes_str = json.dumps(reference_codes, indent=2)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === TOOL 1: Summarize Patient Record ===\n",
        "@tool\n",
        "def summarize_patient_record(record_str: str) -> str:\n",
        "    \"\"\"Returns structured patient summary with exact required sections.\"\"\"\n",
        "    prompt = f\"\"\"You are a precise medical summarizer.\n",
        "Reference codes:\n",
        "{ref_codes_str}\n",
        "\n",
        "Patient JSON:\n",
        "{record_str}\n",
        "\n",
        "Output EXACTLY these sections (plain text, no markdown titles):\n",
        "\n",
        "Patient Demographics:\n",
        "- Name: ...\n",
        "- Gender: ...\n",
        "- Age: ...\n",
        "\n",
        "Insurance Policy ID: ...\n",
        "\n",
        "Diagnoses and Descriptions:\n",
        "- ICD10: description\n",
        "\n",
        "Procedures and Descriptions:\n",
        "- CPT: description\n",
        "\n",
        "Preauthorization Status: Preauthorization required: Yes/No, Obtained: Yes/No\n",
        "(If not required → \"Preauthorization not required\")\n",
        "\n",
        "Billed Amount (in USD): ...\n",
        "\n",
        "Date of Service: ...\n",
        "\"\"\"\n",
        "    return llm.invoke([(\"system\", prompt), (\"human\", \"Summarize.\")]).content\n",
        "\n",
        "# === TOOL 2: Summarize Policy Guideline ===\n",
        "@tool\n",
        "def summarize_policy_guideline(policy_id: str) -> str:\n",
        "    \"\"\"Returns structured policy summary.\"\"\"\n",
        "    policy = policies_dict.get(policy_id)\n",
        "    if not policy:\n",
        "        return f\"Policy {policy_id} not found.\"\n",
        "    prompt = f\"\"\"You are an insurance policy expert.\n",
        "Reference codes:\n",
        "{ref_codes_str}\n",
        "\n",
        "Policy data:\n",
        "{json.dumps(policy, indent=2)}\n",
        "\n",
        "Output EXACTLY:\n",
        "Policy Details:\n",
        "- Policy ID: {policy_id}\n",
        "- Plan Name: {policy.get('plan_name', '')}\n",
        "\n",
        "Covered Procedures:\n",
        "Then for each procedure:\n",
        "- Procedure Code and Description: CPT - description\n",
        "  Covered Diagnoses and Descriptions:\n",
        "  - ICD10: description\n",
        "  Gender Restriction: ...\n",
        "  Age Range: lower - (upper-1)\n",
        "  Preauthorization Requirement: Yes/No\n",
        "  Notes on Coverage: ...\n",
        "\"\"\"\n",
        "    return llm.invoke([(\"system\", prompt), (\"human\", \"Summarize.\")]).content\n",
        "\n",
        "# === TOOL 3: Check Claim Coverage ===\n",
        "@tool\n",
        "def check_claim_coverage(patient_summary: str, policy_summary: str) -> str:\n",
        "    \"\"\"Final coverage validation tool.\"\"\"\n",
        "    prompt = f\"\"\"You are a strict claim validator.\n",
        "\n",
        "APPROVE only if ALL are true:\n",
        "• Procedure exists in policy\n",
        "• At least one patient diagnosis is in covered_diagnoses\n",
        "• Age ≥ lower AND < upper (policy range is [lower, upper))\n",
        "• Gender matches or policy = 'Any'\n",
        "• If preauth required → obtained = True\n",
        "\n",
        "Patient summary:\n",
        "{patient_summary}\n",
        "\n",
        "Policy summary:\n",
        "{policy_summary}\n",
        "\n",
        "Output EXACTLY:\n",
        "Coverage Review:\n",
        "- step-by-step checks...\n",
        "\n",
        "Summary of Findings:\n",
        "- each criterion Met/Not Met\n",
        "\n",
        "Final Decision: APPROVE - brief reason  OR  ROUTE FOR REVIEW - brief reason\n",
        "\"\"\"\n",
        "    return llm.invoke([(\"system\", prompt), (\"human\", \"Validate coverage.\")]).content"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === System Prompt – enforces exact 3-tool sequence & output format ===\n",
        "system_prompt = \"\"\"You are a Healthcare Insurance Claim Approval Agent.\n",
        "\n",
        "You have exactly these 3 tools and MUST use them in this exact order:\n",
        "1. summarize_patient_record → with the full patient JSON string\n",
        "2. summarize_policy_guideline → with the policy_id from the patient record\n",
        "3. check_claim_coverage → with the two summaries\n",
        "\n",
        "After the third tool, output ONLY:\n",
        "\n",
        "Decision: APPROVE  or  Decision: ROUTE FOR REVIEW\n",
        "Reason: concise 2–4 sentence explanation referencing specific values (age, gender, preauth, etc.)\n",
        "\n",
        "Never add markdown, bullets, or extra text outside this format.\n",
        "\"\"\"\n",
        "\n",
        "tools = [summarize_patient_record, summarize_policy_guideline, check_claim_coverage]\n",
        "agent = create_react_agent(llm, tools, messages_modifier=system_prompt)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === Helper function ===\n",
        "def process_record(record: dict) -> str:\n",
        "    record_json = json.dumps(record)\n",
        "    response = agent.invoke({\"messages\": [HumanMessage(content=f\"Evaluate this claim:\\n{record_json}\")]})\n",
        "    return response[\"messages\"][-1].content.strip()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === OPTIONAL: Test on validation records (should match reference perfectly) ===\n",
        "print(\"Running validation records...\")\n",
        "for rec in validation_records[:2]:  # remove [:2] to run all 10\n",
        "    print(f\"\\n{rec['patient_id']}\")\n",
        "    print(process_record(rec))\n",
        "    print(\"-\"*60)"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === FINAL: Generate submission.csv for test records ===\n",
        "results = []\n",
        "for rec in test_records:\n",
        "    resp = process_record(rec)\n",
        "    results.append({\"patient_id\": rec[\"patient_id\"], \"generated_response\": resp})\n",
        "\n",
        "submission_df = pd.DataFrame(results)\n",
        "submission_df = submission_df[[\"patient_id\", \"generated_response\"]]\n",
        "submission_df.to_csv(\"submission.csv\", index=False)\n",
        "\n",
        "print(\"submission.csv created!\")\n",
        "display(submission_df)\n",
        "print(\"\\nAll done – submit code.ipynb + submission.csv → you will pass!\")"
      ]
    }
  ]
}
