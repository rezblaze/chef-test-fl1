from langgraph.prebuilt import create_react_agent
from langchain_core.messages import SystemMessage, HumanMessage
import json

system_prompt = """You are a Healthcare Insurance Claim Approval Agent.
You have exactly 3 tools. Always use them in this exact order:

1. Call summarize_patient_record with the full patient JSON
2. Extract the Policy ID from its output and call summarize_policy_guideline
3. Call check_claim_coverage with both summaries
4. After the 3rd tool returns, output the final decision.

Final output must be exactly:

Decision: APPROVE
Reason: <short accurate reason with codes, age, gender, preauth>

OR

Decision: ROUTE FOR REVIEW
Reason: <short reason why not approved>

No markdown, no extra text, no bullets."""

# This line fixes the error in Databricks
try:
    agent_executor = create_react_agent(llm, tools, messages_modifier=SystemMessage(content=system_prompt))
except:
    agent_executor = create_react_agent(llm, tools, state_modifier=SystemMessage(content=system_prompt))

def run_claim(rec):
    msg = HumanMessage(content="Evaluate this insurance claim:\n" + json.dumps(rec, indent=2))
    result = agent_executor.invoke({"messages": [msg]})
    return result["messages"][-1].content.strip()

print("Agent fixed and ready!")
